# Умное избежание конфликтов CIP

## Проблема

При автоматической вставке CIP возникала проблема наложения на существующие CIP-переходы:

```
Пример:
- Порог автосопровождения: 60000 шт
- Через 2000 шт (на 62000) уже идет обычный CIP-переход
- Алгоритм пытался вставить автосопровождение на 62000
- Результат: два CIP одновременно, что невозможно
```

## Решение

Добавлена логика обнаружения и избежания конфликтов с существующими CIP.

### Алгоритм работы

1. **Определение места вставки** - рассчитывается время для автосопровождения
2. **Проверка конфликтов** - проверяется, нет ли CIP в этом временном интервале
3. **Поиск свободного слота** - если есть конфликт, ищется следующий свободный интервал
4. **Вставка с сдвигом** - CIP вставляется в свободное время

### Функции

#### `_check_cip_conflict(results, start_time, duration, line)`
Проверяет наличие конфликтов с существующими CIP в заданном интервале.

```python
# Проверяет пересечение временных интервалов
# Возвращает True если есть конфликт, False если свободно
```

#### `_find_next_free_slot(results, base_dt, start_time, duration, line)`
Ищет следующий свободный слот для CIP, пропуская занятые интервалы.

```python
# Перебирает время вперед с шагом duration
# Возвращает первое свободное время или исходное если слот не найден
```

### Пример работы

```
Исходная ситуация:
- Автосопровождение хочет вставиться на 620 мин
- В это время уже идет обычный CIP (610-640 мин)

Результат:
- Конфликт обнаружен
- Ищется следующий свободный слот
- CIP вставляется на 650 мин (после окончания обычного CIP)
```

### Логирование

```
[АВТО-CIP] Вставка CIP2 на линия 1: Общий объем достиг 60000 шт
[АВТО-CIP] Конфликт с существующим CIP, сдвигаем с 620 мин на 650 мин
```

### Преимущества

1. **Избежание конфликтов** - автосопровождение не накладывается на обычные CIP
2. **Автоматический поиск** - система сама находит свободное время
3. **Сохранение логики** - основная логика автосопровождения не меняется
4. **Гибкость** - работает с любыми типами CIP (CIP1, CIP2, CIP3, ВЫТ, П)

### Ограничения

- Поиск свободного слота ограничен продолжительностью смены (24 часа)
- Если свободный слот не найден, используется исходное время (с риском конфликта)

### Файлы изменений

- `schedule_tab.py` - добавлены функции обнаружения конфликтов и поиска свободных слотов
- `test_cip_conflicts.py` - тесты для проверки логики конфликтов
