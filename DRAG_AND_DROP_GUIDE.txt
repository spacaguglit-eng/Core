═══════════════════════════════════════════════════════════════════════════
  РУКОВОДСТВО ПО ПЕРЕТАСКИВАНИЮ СТРОК (DRAG & DROP)
═══════════════════════════════════════════════════════════════════════════

ДАТА: 28.10.2025

ЧТО ИЗМЕНИЛОСЬ:
──────────────────────────────────────────────────────────────────────────

✅ Добавлена возможность перетаскивания строк мышью
✅ Отображается реальный порядок из файла (без автосортировки)
✅ Автосохранение после перетаскивания
✅ Отключена автосортировка при редактировании приоритета
✅ Сортировка по клику на заголовок ОТКЛЮЧЕНА (сохраняет порядок)

──────────────────────────────────────────────────────────────────────────

КАК ИСПОЛЬЗОВАТЬ:
──────────────────────────────────────────────────────────────────────────

1. ПЕРЕТАСКИВАНИЕ СТРОК:
   
   • Зажмите левую кнопку мыши на строке
   • Переместите мышь вверх или вниз (минимум 5 пикселей)
   • Отпустите кнопку мыши на нужной позиции
   • Строка переместится, порядок автоматически сохранится

2. ВИЗУАЛЬНАЯ ОБРАТНАЯ СВЯЗЬ:
   
   • При перетаскивании строка подсвечивается
   • Видно куда будет вставлена строка
   • После перемещения: "✅ Порядок изменен и сохранен"

3. РЕДАКТИРОВАНИЕ ЯЧЕЕК:
   
   • Двойной клик на ячейке - начать редактирование
   • Enter - сохранить, Escape - отменить
   • Автосортировка при изменении приоритета ОТКЛЮЧЕНА

4. РУЧНАЯ СОРТИРОВКА:
   
   • Кнопка "🎯 Сортировать по приоритету (⚠️ изменит порядок)"
   • Сортирует все записи по приоритету
   • ⚠️ ВНИМАНИЕ: Изменит ручной порядок!

──────────────────────────────────────────────────────────────────────────

ПРАВИЛА ПЕРЕТАСКИВАНИЯ:
──────────────────────────────────────────────────────────────────────────

✓ Можно перетаскивать только внутри одной линии
✓ Нельзя перетащить запись в группу или наоборот
✓ Порядок сохраняется автоматически после каждого перемещения
✓ Клик без перемещения = обычный клик (выбор строки)
✓ Двойной клик = редактирование (как раньше)

──────────────────────────────────────────────────────────────────────────

ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ:
──────────────────────────────────────────────────────────────────────────

ПРИМЕР 1: Изменение порядка для блокировки приоритета

Исходный порядок:
  1. J-002 - Шоколадное Печенье (P1)
  2. J-007 - Миндаль (P1)
  3. J-003 - Кокос (P1)

Хотите порядок:
  1. J-007 - Миндаль (P1)
  2. J-003 - Кокос (P1)
  3. J-002 - Шоколадное Печенье (P1)

Действия:
  1. Перетащите J-007 на первое место
  2. Перетащите J-003 на второе место
  3. Порядок сохранится автоматически
  4. Теперь при построении расписания с блокировкой P1 
     будет использоваться именно этот порядок!


ПРИМЕР 2: Группировка похожих продуктов

Исходный порядок:
  1. Сироп Ваниль
  2. Топпинг Шоколад
  3. Сироп Карамель
  4. Топпинг Клубника

Хотите сгруппировать:
  1. Сироп Ваниль
  2. Сироп Карамель  ← рядом с другим сиропом
  3. Топпинг Шоколад
  4. Топпинг Клубника

Действия:
  1. Перетащите "Сироп Карамель" вверх под "Сироп Ваниль"
  2. Готово! Все сиропы вместе, все топпинги вместе

──────────────────────────────────────────────────────────────────────────

ТЕХНИЧЕСКИЕ ДЕТАЛИ:
──────────────────────────────────────────────────────────────────────────

1. ОПРЕДЕЛЕНИЕ DRAG vs CLICK:
   
   • Минимальное движение: 5 пикселей
   • Минимальное время: 0.1 секунды
   • Если не выполнено - считается обычным кликом

2. АВТОСОХРАНЕНИЕ:
   
   • После каждого перемещения вызывается _save_json()
   • Порядок сохраняется в jobs_plan.json
   • Нумерация JSON определяет порядок

3. ОТКЛЮЧЕННЫЕ ФУНКЦИИ:
   
   • _enable_tree_sort() - теперь пустая (не добавляет сортировку на клик)
   • Автосортировка при изменении приоритета (закомментирована)
   • Клик на заголовок колонки НЕ сортирует

4. CALLBACK:
   
   • on_reorder_callback вызывается после успешного перемещения
   • Используется для автосохранения и обновления статуса

──────────────────────────────────────────────────────────────────────────

СВЯЗЬ С БЛОКИРОВКОЙ ПРИОРИТЕТОВ:
──────────────────────────────────────────────────────────────────────────

Теперь блокировка работает правильно:

1. УСТАНАВЛИВАЕТЕ ПОРЯДОК В ПЛАНЕ:
   
   Линия 5, Приоритет 1:
     1. J-007 - Миндаль
     2. J-003 - Кокос
     3. J-001 - Имбирный Пряник
     4. J-009 - Корица
     5. J-002 - Шоколадное Печенье

2. БЛОКИРУЕТЕ ПРИОРИТЕТ 1:
   
   • Вкладка "Планирование" → "🔒 Заблокировать приоритеты"
   • Или в поле "Фиксировать для приоритетов: 1"

3. СТРОИТЕ РАСПИСАНИЕ:
   
   • Вкладка "Расписание"
   • Включите "🔧 CP-SAT оптимизация"
   • Нажмите "📅 Построить расписание"

4. РЕЗУЛЬТАТ:
   
   Порядок работ с P1 СОХРАНЕН:
     1. J-007 - Миндаль ✓
     2. J-003 - Кокос ✓
     3. J-001 - Имбирный Пряник ✓
     4. J-009 - Корица ✓
     5. J-002 - Шоколадное Печенье ✓

──────────────────────────────────────────────────────────────────────────

ЧАСТЫЕ ВОПРОСЫ:
──────────────────────────────────────────────────────────────────────────

В: Не получается перетащить строку?
О: Убедитесь что:
   - Держите кнопку нажатой
   - Двигаете мышь хотя бы на 5-10 пикселей
   - Перетаскиваете внутри одной линии (не между группами)

В: Двойной клик не работает?
О: Работает! Убедитесь что кликаете ДВА раза БЫСТРО на одной ячейке.

В: Как вернуть автосортировку по клику на заголовок?
О: Не рекомендуется - это нарушит ручной порядок.
   Используйте кнопку "🎯 Сортировать по приоритету" для ручной сортировки.

В: Почему порядок в расписании другой?
О: Проверьте:
   - Не нажимали ли "Сортировать по приоритету" (это изменит порядок)
   - Сохранен ли план после перетаскивания (должно быть "✅ Порядок изменен и сохранен")
   - Правильно ли заблокирован приоритет

──────────────────────────────────────────────────────────────────────────

ИЗМЕНЕННЫЕ ФАЙЛЫ:
──────────────────────────────────────────────────────────────────────────

planning_tab.py:
  • Строки 71-74: Отключена _enable_tree_sort()
  • Строки 76-164: Добавлена функция _enable_drag_and_drop()
  • Строки 966-968: Отключена автосортировка при изменении приоритета
  • Строка 736: Обновлен текст кнопки "Сортировать"
  • Строки 1314-1321: Инициализация drag & drop с callback

──────────────────────────────────────────────────────────────────────────

ИТОГИ:
──────────────────────────────────────────────────────────────────────────

✅ Порядок в плане ВСЕГДА соответствует файлу jobs_plan.json
✅ Перетаскивание мышью работает интуитивно
✅ Автосохранение после каждого перемещения
✅ Блокировка приоритетов теперь работает правильно
✅ Редактирование ячеек по-прежнему работает
✅ Ручная сортировка доступна через кнопку

═══════════════════════════════════════════════════════════════════════════

