# Улучшенный экспорт в Excel с автофитом

## Что было исправлено?

Исправлен алгоритм автоматической подгонки ширины столбцов в экспорте Excel. Теперь ширина рассчитывается точно, как встроенный автофит в Excel.

## Основные улучшения

### ✅ Старый алгоритм (проблемы)
- Считал только количество символов
- Не учитывал реальную ширину разных букв
- Игнорировал размер и тип шрифта
- **Результат:** столбцы были слишком узкими или слишком широкими

### ✅ Новый алгоритм (решение)
- Учитывает реальную ширину каждого символа:
  - Широкие буквы (M, W, Ш, Щ): **1.3 единицы**
  - Заглавные и кириллица: **1.2 единицы**
  - Обычные символы: **1.0 единиц**
  - Узкие символы (i, j, l, !): **0.5 единиц**
- Учитывает размер шрифта
- Учитывает жирное начертание (+10%)
- Пропускает объединённые ячейки
- Добавляет увеличенный padding (3.5) для гарантии
- **Выравнивает все данные по центру**
- Ограничивает максимальную ширину (80)

## Изменённые файлы

1. **schedule_excel_export.py** - основной экспорт расписания
2. **export_from_schedule.py** - экспорт из JSON
3. **test_autofit.py** - тестовый файл

## Примеры результатов

### Тестовый файл (test_autofit.xlsx)
```
Колонка A (Время начала):     15.7 ед.  ✓
Колонка B (Время окончания):  18.7 ед.  ✓
Колонка C (Длительность):     15.7 ед.  ✓
Колонка D (Продукт):          37.0 ед.  ✓ ← Весь текст влезает!
Колонка E (Количество):       13.7 ед.  ✓

Выравнивание: ПО ЦЕНТРУ
Padding: 3.5 (увеличен для гарантии)
```

## Как использовать

### Экспорт расписания из GUI
```python
# В вашем приложении вызывается автоматически
from schedule_excel_export import export_schedule_to_excel

# Экспортирует с правильным автофитом
export_schedule_to_excel(schedule_data, "Расписание.xlsx")
```

### Тестирование автофита
```bash
# Запустите тест
python test_autofit.py

# Запустите демо с реальными данными
python demo_autofit.py
```

## Преимущества

✅ **Профессиональный вид** - файлы выглядят как созданные вручную  
✅ **Экономия времени** - не нужно вручную подгонять столбцы  
✅ **Читаемость** - весь текст виден полностью, ничего не обрезается  
✅ **Точность** - учитывается кириллица и разные шрифты  
✅ **Центрирование** - все данные красиво выровнены по центру  
✅ **Гарантия** - увеличенный padding обеспечивает влезание любого текста  

## Технические детали

Алгоритм использует специальную формулу для расчёта ширины:

```python
width = sum(char_width for char in text) * (font_size / 11) * bold_factor + padding
```

где:
- `char_width` - ширина каждого символа (0.5-1.3)
- `font_size` - размер шрифта (базовый: 11)
- `bold_factor` - коэффициент для жирного текста (1.0 или 1.1)
- `padding` - отступы (+3.5 единицы, увеличен для гарантии)

Плюс все ячейки выравниваются по центру для лучшего внешнего вида.

## Файлы для проверки

После изменений созданы следующие тестовые файлы:
- `test_autofit.xlsx` - простой тест с базовыми данными
- `demo_autofit_improved.xlsx` - демо с реальными данными расписания
- `AUTOFIT_CHANGES.txt` - детальное описание изменений

---

**Дата обновления:** 28 октября 2025  
**Статус:** ✅ Протестировано и готово к использованию

